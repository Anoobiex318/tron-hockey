<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tron Hockey</title>
    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@100..900&family=Montserrat:wght@900&display=swap"
        rel="stylesheet">
</head>

<body>

    <div class="scanlines"></div>

    <div id="game-container">
        <canvas id="gameCanvas"></canvas>

        <div class="ui-layer">
            <!-- Score is now on canvas -->
        </div>

        <div id="main-menu" class="menu-overlay">
            <div class="info-toggle" onclick="document.getElementById('info-modal').classList.remove('hidden')">?</div>
            <img src="icon.png" class="menu-logo" alt="Logo">
            <div class="title" style="position: relative;">
                TRON<br>HOCKEY<sup id="app-version-display"
                    style="font-size: 0.6rem; font-family: 'Outfit', sans-serif; opacity: 0.4; letter-spacing: 1px; margin-left: 2px; text-transform: none; -webkit-text-fill-color: #fff; font-weight: normal;">v1.0.30</sup>
            </div>
            <div class="subtitle">NEON LEAGUE</div>

            <!-- Mode Menu -->
            <div id="mode-menu" class="menu-content">
                <button class="btn btn-cyan" onclick="showCpuMenu()">VS BOT</button>
                <button class="btn btn-magenta" onclick="startGame('local')">Local (2P)</button>
                <button class="btn btn-yellow" onclick="openLobby()">ONLINE 1v1</button>

                <button id="update-app-btn" class="btn btn-green" onclick="updateApp()">
                    CHECK UPDATES
                </button>
            </div>

            <!-- CPU Difficulty Menu (Hidden) -->
            <div id="cpu-menu" class="menu-content hidden">
                <div class="menu-group">
                    <div class="difficulty-label">DIFFICULTY</div>
                    <input type="hidden" id="difficulty-select" value="medium">
                    <div class="difficulty-row">
                        <div class="diff-btn active" onclick="selectDiff('medium', this)">MEDIUM</div>
                        <div class="diff-btn" onclick="selectDiff('difficult', this)">DIFFICULT</div>
                        <div class="diff-btn" onclick="selectDiff('insane', this)">INSANE</div>
                    </div>
                </div>
                <button class="btn btn-cyan" onclick="startGame('cpu')">START GAME</button>
                <button class="btn btn-magenta" onclick="showMainMenu()">BACK</button>
            </div>

            <div id="highscore-display" style="margin-top: 15px; color: #0ff; text-shadow: 0 0 5px #0ff;">
                WINS: 0
            </div>
        </div>

        <!-- Gameplay UI (Pause/Flip) -->
        <div id="game-ui" class="ui-layer hidden">
            <button id="pause-btn" class="icon-btn" onclick="togglePause()">
                ||
            </button>
            <button id="flip-btn" class="icon-btn" onclick="toggleFlip()">
                &#8635;
            </button>
        </div>

        <!-- Turn Indicator -->
        <div id="turn-indicator" class="hidden"
            style="position: absolute; left: 50%; transform: translateX(-50%); padding: 10px 20px; background: rgba(0,0,0,0.6); border: 1px solid var(--primary-glow); border-radius: 10px; color: #fff; font-weight: bold; z-index: 60; pointer-events: none; backdrop-filter: blur(5px); text-transform: uppercase; letter-spacing: 2px;">
            PLAYER 1 TURN
        </div>

        <!-- Countdown Overlay -->
        <div id="countdown-overlay" class="menu-overlay hidden" style="background: transparent; pointer-events: none;">
            <div id="countdown-text"
                style="font-size: 8rem; color: var(--primary-color); text-shadow: 0 0 20px var(--primary-color), 0 0 40px var(--primary-color); font-weight: bold; font-family: sans-serif;">
                3</div>
        </div>
    </div>

    <div id="game-over-modal" class="menu-overlay hidden">
        <div class="title" id="game-over-title">YOU WIN</div>
        <div class="subtitle" id="game-over-score">7 - 5</div>
        <div class="menu-content">
            <button id="game-over-menu-btn" class="btn btn-cyan" onclick="returnToMenu()">MAIN MENU</button>
            <button class="btn btn-cyan" onclick="restartGame()">REMATCH</button>
            <button id="game-over-exit-btn" class="btn btn-magenta" onclick="stopGame()">EXIT</button>
        </div>
    </div>

    <div id="lobby-modal" class="menu-overlay hidden">
        <div class="title">ONLINE LOBBY</div>
        <div class="subtitle" id="lobby-status">CONNECTING...</div>

        <div class="menu-group">
            <div class="lobby-section">
                <label for="peer-id-input">Your ID:</label>
                <input type="text" id="peer-id-input" readonly>
                <button class="btn btn-small" onclick="copyPeerId()">Copy</button>
            </div>
            <div class="lobby-section">
                <label for="connect-id-input">Connect to ID:</label>
                <input type="text" id="connect-id-input" placeholder="Enter opponent's ID">
                <button class="btn btn-small" onclick="connectToPeer()">Connect</button>
            </div>
        </div>

        <div id="connection-status" style="margin-top: 10px;"></div>

        <button class="btn btn-magenta" onclick="closeLobby()">EXIT LOBBY</button>
    </div>

    <!-- Pause Menu (This is full screen overlay, can stay out or in, but usually full screen is better out) -->
    <!-- Actually user complained about pause button positioning, not the menu itself. -->
    <div id="pause-modal" class="menu-overlay hidden">
        <div id="pause-title" class="title">PAUSED</div>
        <div class="menu-content">
            <button id="resume-btn" class="btn" onclick="togglePause()">RESUME</button>
            <button id="pause-exit-btn" class="btn btn-magenta" onclick="stopGame()">EXIT</button>
        </div>
    </div>

    <!-- Install App Modal -->
    <div id="install-modal" class="menu-overlay hidden" style="background: rgba(0,0,0,0.9);">
        <div class="title" style="font-size: 2.5rem;">INSTALL APP</div>
        <div class="subtitle" style="font-size: 1rem; margin-bottom: 20px; letter-spacing: 2px; line-height: 1.5;">
            Enter the Grid.<br>Play Offline & Lag-Free.
        </div>
        <div class="menu-content">
            <button id="install-btn" class="btn">INSTALL NOW</button>
            <button class="btn btn-magenta"
                onclick="document.getElementById('install-modal').classList.add('hidden')">LATER</button>
        </div>
    </div>

    <!-- Offline Warning Modal -->
    <div id="offline-modal" class="menu-overlay hidden" style="z-index: 2000;">
        <div class="title" style="color: #ff3366; text-shadow: 0 0 10px #ff3366;">OFFLINE</div>
        <div class="subtitle" style="font-size: 1rem;">Internet Connection Required</div>
        <button class="btn" onclick="document.getElementById('offline-modal').classList.add('hidden')">OK</button>
    </div>

    <!-- Update Confirmation Modal -->
    <div id="update-modal" class="menu-overlay hidden" style="z-index: 2000;">
        <div class="title" style="font-size: 2.5rem; color: #0ff;">UPDATE</div>
        <div class="subtitle"
            style="font-size: 1rem; margin-bottom: 20px; text-align: center; letter-spacing: 1px; padding: 0 20px;">
            New version available.<br>Refresh to apply updates?
        </div>
        <div class="menu-content">
            <button class="btn btn-cyan" onclick="performUpdate()">UPDATE NOW</button>
            <button class="btn btn-magenta"
                onclick="document.getElementById('update-modal').classList.add('hidden')">CANCEL</button>
        </div>
    </div>

    <!-- Alerts/Notice Modal -->
    <div id="alert-modal" class="menu-overlay hidden" style="z-index: 2500;">
        <div class="title" id="alert-title" style="font-size: 2.22rem; color: var(--secondary-color);">NOTICE</div>
        <div class="subtitle" id="alert-message" style="font-size: 1rem; padding: 0 20px;"></div>
        <button class="btn" onclick="document.getElementById('alert-modal').classList.add('hidden')">OK</button>
    </div>

    <!-- Player Left Modal -->
    <div id="player-left-modal" class="menu-overlay hidden" style="z-index: 2600;">
        <div class="title" style="color: #ff3366;">LINK LOST</div>
        <div class="subtitle">OPPONENT LEFT THE MATCH</div>
        <button class="btn"
            onclick="stopGame(); document.getElementById('player-left-modal').classList.add('hidden');">RETURN TO
            MENU</button>
    </div>

    <!-- Info/Credits Modal -->
    <div id="info-modal" class="menu-overlay hidden" style="z-index: 2100; background: rgba(0,0,0,0.95);">
        <div class="title" style="font-size: 2rem; color: #ffaa00;">About Game</div>
        <div
            style="color: #fff; text-align: center; font-family: sans-serif; line-height: 1.6; font-size: 0.9rem; padding: 20px;">
            <p style="margin-bottom: 15px; color: #bbb;">Created by childish and retro mind of:</p>
            <p
                style="font-size: 1.5rem; font-weight: bold; color: #0ff; margin-bottom: 20px; text-shadow: 0 0 10px #0ff, 0 0 20px #0ff;">
                Mark Darwin C. Villarta
            </p>

            <p style="margin-bottom: 10px; color: #bbb;">Buy me a coffee (Tap to Copy):</p>
            <div style="display: flex; flex-direction: column; gap: 10px; align-items: center; margin-bottom: 20px;">
                <div onclick="copyToClipboard('elitepro318@gmail.com', 'PayPal'); this.style.color='#0f0'; setTimeout(()=>this.style.color='#0070ba', 1000)"
                    style="cursor: pointer; padding: 8px 15px; border: 1px solid #0070ba; color: #0070ba; border-radius: 4px; width: 100%; font-size: 0.8rem; transition: all 0.2s;">
                    PayPal: elitepro318@gmail.com
                </div>
                <div onclick="copyToClipboard('09104049265', 'GCash'); this.style.color='#0f0'; setTimeout(()=>this.style.color='#0057e7', 1000)"
                    style="cursor: pointer; padding: 8px 15px; border: 1px solid #0057e7; color: #0057e7; border-radius: 4px; width: 100%; font-size: 0.8rem; transition: all 0.2s;">
                    GCash: 09104049265
                </div>
            </div>

            <p style="margin-bottom: 5px; font-style: italic; color: #888;">Inspired by Symbian OS Game:<br>Tron Hockey
                &#8482</p>
            <p style="margin-top: 20px; font-size: 0.8rem; color: #555;">All rights reserve 2015</p>
        </div>
        <button class="btn btn-secondary"
            onclick="document.getElementById('info-modal').classList.add('hidden')">CLOSE</button>
    </div>

    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="script.js"></script>
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js')
                .then(reg => {
                    console.log('SW registered!', reg);
                    // Check for updates
                    reg.onupdatefound = () => {
                        const newWorker = reg.installing;
                        newWorker.onstatechange = () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                // New content available
                                const updateBtn = document.getElementById('update-app-btn');
                                if (updateBtn) {
                                    updateBtn.textContent = "UPDATE AVAILABLE!";
                                    updateBtn.style.borderColor = "#0f0";
                                    updateBtn.style.color = "#0f0";
                                }
                            }
                        };
                    };
                })
                .catch(err => console.log('SW failed', err));
        }
    </script>
</body>

</html>